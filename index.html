<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Call Break - Point Calculator</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM -->
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone@7.24.7/babel.min.js"></script>
    <!-- Font Awesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" rel="stylesheet" />
    <!-- Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', system-ui, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        /* Animations */
        @keyframes bounceIn { 0% { transform: scale(0.3); opacity: 0; } 50% { transform: scale(1.05); opacity: 1; } 70% { transform: scale(0.9); } 100% { transform: scale(1); } }
        .animate-bounceIn { animation: bounceIn 0.6s ease-out; }
        @keyframes fadeIn { 0% { opacity: 0; transform: translateY(10px); } 100% { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.5s ease-out forwards; }
        
        /* Custom Styles */
        .header-gradient { background: linear-gradient(90deg, #1e3a8a, #312e81); }
        .gradient-button { background: linear-gradient(45deg, #22c55e, #16a34a); transition: transform .2s, box-shadow .2s; }
        .gradient-button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(22, 163, 74, 0.4); }
        .gradient-button:disabled { background: #9ca3af; cursor: not-allowed; opacity: 0.7; }
        .table-header-sticky { position: sticky; left: 0; z-index: 10; }
        .leader-row { background-color: #fef9c3; }
        .dark .leader-row { background-color: #4a411c; }
        .leader-cell { background-color: #fef9c3; }
        .dark .leader-cell { background-color: #4a411c; }
        
        .overlay { position: fixed; inset: 0; background-color: rgba(0,0,0,.7); display: flex; justify-content: center; align-items: center; z-index: 1000; padding: 1rem; backdrop-filter: blur(4px); }
        .modal-box { background: white; padding: 2rem; border-radius: .75rem; box-shadow: 0 10px 25px rgba(0,0,0,.3); max-width: 90%; width: 500px; animation: bounceIn .4s ease-out; }
        .dark .modal-box { background-color: #1f2937; color: #e5e7eb; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        const TOTAL_ROUNDS = 5;

        // Helper function to create initial state
        const createInitialState = () => ({
            players: Array(4).fill(null).map((_, i) => ({
                name: `Player ${i + 1}`,
                scores: Array(TOTAL_ROUNDS).fill(null),
                overtricks: 0
            })),
            round: 1,
            calls: { 0: '', 1: '', 2: '', 3: '' },
            tricks: { 0: '', 1: '', 2: '', 3: '' },
            error: '',
            gameEnded: false,
        });

        // Main App Component
        const App = () => {
            const [gameState, setGameState] = useState(createInitialState());
            const [showRules, setShowRules] = useState(false);
            const [darkMode, setDarkMode] = useState(false);
            const [isEditingNames, setIsEditingNames] = useState(false);

            useEffect(() => {
                const isDark = localStorage.getItem('darkMode') === 'true';
                setDarkMode(isDark);
                document.documentElement.classList.toggle('dark', isDark);
            }, []);

            const toggleDarkMode = () => {
                const newDarkMode = !darkMode;
                setDarkMode(newDarkMode);
                localStorage.setItem('darkMode', newDarkMode);
                document.documentElement.classList.toggle('dark', newDarkMode);
            };

            const handlePlayerNameChange = (index, newName) => {
                setGameState(prev => {
                    const newPlayers = [...prev.players];
                    newPlayers[index].name = newName;
                    return { ...prev, players: newPlayers };
                });
            };

            const handleInputChange = (type, index, value) => {
                // Allow only digits or empty string
                if (!/^\d*$/.test(value)) return;

                const max = type === 'calls' ? 8 : 13;
                const num = value === '' ? '' : Math.min(parseInt(value, 10), max);

                setGameState(prev => ({
                    ...prev,
                    [type]: { ...prev[type], [index]: num }
                }));
            };

            const handleCalculateRound = () => {
                setGameState(prev => ({ ...prev, error: '' }));

                const { players, calls, tricks, round } = gameState;
                
                const trickValues = Object.values(tricks).map(t => parseInt(t, 10) || 0);
                const totalTricks = trickValues.reduce((sum, t) => sum + t, 0);

                if (totalTricks !== 13) {
                    setGameState(prev => ({ ...prev, error: `Total tricks must be 13. You have entered ${totalTricks}.` }));
                    return;
                }

                // Calculate scores for the current round
                const updatedPlayers = players.map((player, index) => {
                    const newPlayer = JSON.parse(JSON.stringify(player)); // Deep copy
                    const call = parseInt(calls[index], 10);
                    const trick = parseInt(tricks[index], 10);
                    let roundScore = 0;

                    // Successful call
                    if (trick >= call) {
                        // Bonus for calling 8 and winning exactly 8
                        if (call === 8 && trick === 8) {
                            roundScore = 13;
                        } else {
                            roundScore = call;
                        }
                        newPlayer.overtricks += (trick - call);
                    } 
                    // Failed call (Break)
                    else {
                        roundScore = -call;
                    }

                    newPlayer.scores[round - 1] = roundScore;
                    return newPlayer;
                });
                
                setGameState(prev => ({
                    ...prev,
                    players: updatedPlayers,
                    round: prev.round < TOTAL_ROUNDS ? prev.round + 1 : prev.round,
                    gameEnded: prev.round >= TOTAL_ROUNDS,
                    calls: { 0: '', 1: '', 2: '', 3: '' },
                    tricks: { 0: '', 1: '', 2: '', 3: '' },
                }));
            };
            
            const handleNewGame = () => {
                setGameState(createInitialState());
                setIsEditingNames(false);
            };

            const playerTotals = useMemo(() => {
                return gameState.players.map(p => {
                    const baseScore = p.scores.reduce((sum, score) => sum + (score || 0), 0);
                    const total = baseScore + (p.overtricks * 0.1);
                    return parseFloat(total.toFixed(1));
                });
            }, [gameState.players]);

            const winner = useMemo(() => {
                if (!gameState.gameEnded) return null;
                const maxScore = Math.max(...playerTotals);
                const winnerIndex = playerTotals.findIndex(score => score === maxScore);
                return { name: gameState.players[winnerIndex].name, score: maxScore };
            }, [gameState.gameEnded, playerTotals, gameState.players]);
            
            const currentLeaderIndex = useMemo(() => {
                if(playerTotals.every(score => score === 0)) return -1;
                const maxScore = Math.max(...playerTotals);
                return playerTotals.indexOf(maxScore);
            }, [playerTotals]);

            const currentTricksTotal = useMemo(() => {
                return Object.values(gameState.tricks).reduce((sum, t) => sum + (parseInt(t, 10) || 0), 0);
            }, [gameState.tricks]);

            const isCalculationDisabled = 
                Object.values(gameState.calls).some(c => c === '') || 
                currentTricksTotal !== 13;
                
            // ===== RENDER SUB-COMPONENTS =====

            const Header = () => (
                <header className="header-gradient text-white p-4 shadow-lg">
                    <div className="container mx-auto flex justify-between items-center">
                        <div className="flex items-center gap-3">
                            <i className="fas fa-calculator text-3xl"></i>
                            <div>
                                <h1 className="text-xl sm:text-2xl font-extrabold tracking-tight">Call Break Calculator</h1>
                                <p className="text-xs text-white/80 -mt-1">Professional Rules</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-4">
                            <button onClick={handleNewGame} className="hidden sm:inline-flex items-center gap-2 bg-white/10 hover:bg-white/20 text-white font-semibold py-2 px-3 rounded-lg shadow-sm transition-all duration-300">
                                <i className="fas fa-redo"></i> New Game
                            </button>
                            <button onClick={toggleDarkMode} className="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Toggle dark mode">
                                {darkMode ? <i className="fas fa-sun text-yellow-400"></i> : <i className="fas fa-moon text-gray-600"></i>}
                            </button>
                        </div>
                    </div>
                </header>
            );

            const Scoreboard = () => (
                <div className="overflow-x-auto shadow-xl rounded-lg bg-white dark:bg-gray-800">
                    <table className="w-full text-sm sm:text-base text-left">
                        <thead className="bg-gray-50 dark:bg-gray-700/50">
                            <tr>
                                <th className="p-3 sm:p-4 font-semibold text-gray-600 dark:text-gray-300 w-2/5 md:w-1/4 table-header-sticky bg-gray-50 dark:bg-gray-700/50">
                                    <div className="flex items-center justify-between">
                                        <span>Player</span>
                                        <button onClick={() => setIsEditingNames(!isEditingNames)} className="text-xs bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 px-2 py-1 rounded">
                                            {isEditingNames ? 'Save' : 'Edit'}
                                        </button>
                                    </div>
                                </th>
                                {[...Array(TOTAL_ROUNDS)].map((_, i) => (
                                    <th key={i} className="p-3 sm:p-4 font-semibold text-center text-gray-600 dark:text-gray-300">R{i + 1}</th>
                                ))}
                                <th className="p-3 sm:p-4 font-semibold text-center text-gray-600 dark:text-gray-300">Total</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-200 dark:divide-gray-700">
                            {gameState.players.map((player, index) => (
                                <tr key={index} className={index === currentLeaderIndex ? 'leader-row' : ''}>
                                    <td className={`p-2 sm:p-3 font-medium table-header-sticky ${index === currentLeaderIndex ? 'leader-cell' : 'bg-white dark:bg-gray-800'}`}>
                                        <div className="flex items-center gap-2">
                                            {index === currentLeaderIndex && <span className="text-yellow-500">🏆</span>}
                                            {isEditingNames ? (
                                                <input
                                                    type="text"
                                                    value={player.name}
                                                    onChange={(e) => handlePlayerNameChange(index, e.target.value)}
                                                    className="w-full bg-transparent font-bold outline-none ring-1 ring-blue-500 rounded px-1"
                                                />
                                            ) : (
                                                <span className="font-bold px-1">{player.name}</span>
                                            )}
                                        </div>
                                    </td>
                                    {player.scores.map((score, i) => (
                                        <td key={i} className={`p-3 sm:p-4 text-center ${score < 0 ? 'text-red-500 font-semibold' : ''}`}>
                                            {score !== null ? score : '-'}
                                        </td>
                                    ))}
                                    <td className="p-3 sm:p-4 text-center font-bold text-lg text-indigo-600 dark:text-indigo-400">
                                        {playerTotals[index]}
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
            
            const InputSection = () => (
                <div className="mt-8 animate-fadeIn">
                    <h2 className="text-2xl font-bold text-center mb-4">
                        Round <span className="text-indigo-600 dark:text-indigo-400">{gameState.round}</span> of {TOTAL_ROUNDS}
                    </h2>
                    <div className="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
                        {gameState.players.map((player, index) => (
                            <div key={index} className="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md">
                                <h3 className="font-semibold truncate">{player.name}</h3>
                                <div className="mt-3 space-y-3">
                                    <input type="number" placeholder="Call" min="1" max="8" value={gameState.calls[index]} onChange={(e) => handleInputChange('calls', index, e.target.value)} className="w-full p-2 text-center border rounded-md dark:bg-gray-700 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 focus:outline-none" />
                                    <input type="number" placeholder="Tricks Won" min="0" max="13" value={gameState.tricks[index]} onChange={(e) => handleInputChange('tricks', index, e.target.value)} className="w-full p-2 text-center border rounded-md dark:bg-gray-700 dark:border-gray-600 focus:ring-2 focus:ring-blue-500 focus:outline-none" />
                                </div>
                            </div>
                        ))}
                    </div>
                    
                    <div className="text-center mt-4 font-medium">
                        <p className={currentTricksTotal !== 13 ? 'text-red-500' : 'text-green-600'}>
                            Total Tricks Entered: {currentTricksTotal} / 13
                        </p>
                        {gameState.error && <p className="text-red-500 mt-1">{gameState.error}</p>}
                    </div>

                    <div className="mt-6 text-center">
                        <button onClick={handleCalculateRound} disabled={isCalculationDisabled} className="gradient-button text-white font-bold py-3 px-10 rounded-full shadow-lg text-lg uppercase tracking-wider">
                            Calculate Round {gameState.round}
                        </button>
                    </div>
                </div>
            );

            const GameEndView = () => (
                 <div className="text-center mt-8 animate-fadeIn">
                    <h2 className="text-2xl font-bold text-green-600">Game Finished!</h2>
                    {winner && <p className="text-lg mt-2">Congratulations to <span className="font-bold">{winner.name}</span>!</p>}
                    <button onClick={handleNewGame} className="mt-6 gradient-button text-white font-bold py-3 px-8 rounded-full shadow-lg text-lg uppercase">
                        Play Again
                    </button>
                 </div>
            );

            const WinnerModal = () => winner && (
                <div className="overlay">
                    <div className="modal-box text-center">
                        <span className="text-7xl mb-4">🎉</span>
                        <h2 className="text-3xl font-bold text-yellow-500">Game Over!</h2>
                        <p className="text-xl mt-4">The winner is</p>
                        <p className="text-4xl font-extrabold text-indigo-600 dark:text-indigo-400 my-2">{winner.name}</p>
                        <p className="text-lg">with a score of <span className="font-bold">{winner.score}</span> points!</p>
                        <button onClick={handleNewGame} className="mt-8 gradient-button text-white font-bold py-3 px-8 rounded-full shadow-lg text-lg uppercase">
                            Start New Game
                        </button>
                    </div>
                </div>
            );

            const RulesModal = () => (
                <div className="overlay" onClick={() => setShowRules(false)}>
                    <div className="modal-box text-left" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-2xl font-bold text-indigo-600 dark:text-indigo-400">Scoring Rules</h2>
                            <button onClick={() => setShowRules(false)} className="text-2xl font-bold opacity-70 hover:opacity-100">&times;</button>
                        </div>
                        <ul className="space-y-3 list-disc list-inside text-gray-700 dark:text-gray-300">
                            <li>The game is played for <strong>5 rounds</strong>.</li>
                            <li>Total tricks won by all 4 players in a round must equal <strong>13</strong>.</li>
                            <li><strong>Successful Call:</strong> If `Tricks Won >= Call`, your score for the round equals your `Call`.</li>
                            <li><strong>Failed Call (Break):</strong> If `Tricks Won < Call`, your score is a negative of your `Call` (e.g., `-3`).</li>
                            <li><strong>Overtricks:</strong> Each extra trick won above your call adds <strong>+0.1</strong> to your cumulative total score.</li>
                            <li><strong>Bonus Score:</strong> If you `Call 8` and win exactly `8 tricks`, you get a bonus score of <strong>13 points</strong> for that round.</li>
                            <li>The player with the <strong>highest total score</strong> after 5 rounds wins the game.</li>
                        </ul>
                    </div>
                </div>
            );

            // ===== MAIN RENDER =====
            
            return (
                <div>
                    <Header />
                    <main className="container mx-auto p-4 md:p-6">
                        <Scoreboard />
                        {gameState.gameEnded ? <GameEndView /> : <InputSection />}
                        
                        <div className="sm:hidden mt-8 text-center">
                            <button onClick={handleNewGame} className="bg-gray-200 dark:bg-gray-700 font-semibold py-2 px-4 rounded-lg">
                                <i className="fas fa-redo mr-2"></i> New Game
                            </button>
                        </div>

                        <button onClick={() => setShowRules(true)} className="fixed bottom-4 right-4 bg-blue-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center text-2xl z-20 hover:bg-blue-700 transition-transform transform hover:scale-110">
                           <i className="fas fa-info"></i>
                        </button>
                    </main>
                    
                    {gameState.gameEnded && winner && <WinnerModal />}
                    {showRules && <RulesModal />}
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
